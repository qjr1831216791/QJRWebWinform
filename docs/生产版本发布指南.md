# 生产版本发布指南

## 📦 发布流程概述

生产版本发布包含以下步骤：
1. 构建前端（Vue 项目）
2. 构建后端（WPF 项目，Release 配置）
3. 打包发布文件
4. 测试验证

## 🚀 快速发布

### 方法一：使用 PowerShell 脚本（推荐）

```powershell
# 在项目根目录执行
.\scripts\build-release.ps1
```

脚本会自动完成所有步骤。

### 方法二：手动发布

按照以下步骤手动执行：

## 📋 详细步骤

### 步骤 1：构建前端

```powershell
# 进入前端目录
cd frontend

# 安装依赖（如果还没有安装）
npm install

# 构建生产版本
npm run build

# 构建完成后，文件会输出到 src/QJRWebWinform.WPF/wwwroot
```

**验证**：检查 `src/QJRWebWinform.WPF/wwwroot` 目录是否包含：
- `index.html`
- `css/` 目录（包含 CSS 文件）
- `js/` 目录（包含 JS 文件）

### 步骤 2：构建后端（Release 配置）

#### 方法 A：使用 Visual Studio

1. 打开 `QJRWebWinform.sln`
2. 在顶部工具栏选择 **Release** 配置
3. 右键点击 `QJRWebWinform.WPF` 项目
4. 选择 **生成** 或按 `Ctrl+Shift+B`
5. 构建完成后，输出文件在 `src/QJRWebWinform.WPF/bin/Release/`

#### 方法 B：使用 MSBuild 命令行

```powershell
# 在项目根目录执行
msbuild QJRWebWinform.sln /p:Configuration=Release /p:Platform="Any CPU" /t:Rebuild
```

**验证**：检查 `src/QJRWebWinform.WPF/bin/Release/` 目录是否包含：
- `QJRWebWinform.WPF.exe` - 主程序
- `QJRWebWinform.WPF.exe.config` - 配置文件
- `wwwroot/` 目录 - 前端文件
- CefSharp 相关 DLL 文件
- 其他依赖文件

### 步骤 3：准备发布包

#### 3.1 创建发布目录

```powershell
# 在项目根目录创建发布目录
mkdir -p release\QJRWebWinform-v1.0.0
cd release\QJRWebWinform-v1.0.0
```

#### 3.2 复制必要文件

需要复制的文件包括：

**必需文件**：
- `QJRWebWinform.WPF.exe` - 主程序
- `QJRWebWinform.WPF.exe.config` - 配置文件
- `wwwroot/` 目录及其所有内容 - 前端文件

**CefSharp 相关文件**（必需）：
- `CefSharp.BrowserSubprocess.Core.dll`
- `CefSharp.BrowserSubprocess.exe`
- `CefSharp.Core.dll`
- `CefSharp.Core.Runtime.dll`
- `CefSharp.dll`
- `CefSharp.Wpf.dll`
- `chrome_elf.dll`
- `libcef.dll`
- `libEGL.dll`
- `libGLESv2.dll`
- `vulkan-1.dll`
- `vk_swiftshader.dll`
- `vk_swiftshader_icd.json`
- `d3dcompiler_47.dll`
- `icudtl.dat`
- `resources.pak`
- `snapshot_blob.bin`
- `v8_context_snapshot.bin`
- `chrome_100_percent.pak`
- `chrome_200_percent.pak`
- `locales/` 目录及其所有内容
- `LICENSE.txt` - CefSharp 许可证

**其他依赖**：
- `Newtonsoft.Json.dll`

**可选文件**：
- `README.txt` - 如果有的话

#### 3.3 使用脚本自动复制

```powershell
# 使用提供的发布脚本
.\scripts\package-release.ps1 -Version "1.0.0"
```

### 步骤 4：测试发布包

1. 在干净的测试环境中（或虚拟机）解压发布包
2. 运行 `QJRWebWinform.WPF.exe`
3. 验证功能是否正常：
   - 应用启动正常
   - 前端界面显示正常
   - NativeHost 通信正常
   - 所有功能按钮正常工作

### 步骤 5：打包分发

#### 创建 ZIP 压缩包

```powershell
# 在 release 目录下
Compress-Archive -Path "QJRWebWinform-v1.0.0\*" -DestinationPath "QJRWebWinform-v1.0.0.zip"
```

#### 创建安装程序（可选）

可以使用以下工具创建安装程序：
- **Inno Setup** - 免费，功能强大
- **NSIS** - 免费，开源
- **WiX Toolset** - 微软官方工具

## 📝 发布检查清单

在发布前，请确认：

### 代码检查
- [ ] 所有功能已测试通过
- [ ] 已移除所有调试代码（`console.log`、`Debug.WriteLine` 等）
- [ ] 已关闭调试模式（`#if DEBUG` 代码块）
- [ ] 版本号已更新

### 构建检查
- [ ] 前端构建成功，无错误
- [ ] 后端 Release 构建成功，无警告
- [ ] `wwwroot` 目录已正确复制到输出目录

### 文件检查
- [ ] 所有必需的文件都已包含
- [ ] 文件大小合理（CefSharp 文件较大是正常的）
- [ ] 没有包含不必要的文件（如 `.pdb` 调试文件）

### 测试检查
- [ ] 在干净环境中测试通过
- [ ] 所有功能正常工作
- [ ] 无运行时错误

## 🔧 发布脚本

### build-release.ps1

完整的发布脚本，包含所有步骤：

```powershell
# 构建前端
Write-Host "构建前端..." -ForegroundColor Green
cd frontend
npm run build
cd ..

# 构建后端
Write-Host "构建后端..." -ForegroundColor Green
msbuild QJRWebWinform.sln /p:Configuration=Release /p:Platform="Any CPU" /t:Rebuild

# 打包
Write-Host "打包发布文件..." -ForegroundColor Green
.\scripts\package-release.ps1 -Version "1.0.0"
```

### package-release.ps1

打包脚本，自动复制所有必需文件：

```powershell
param(
    [Parameter(Mandatory=$true)]
    [string]$Version
)

$sourceDir = "src\QJRWebWinform.WPF\bin\Release"
$targetDir = "release\QJRWebWinform-v$Version"

# 创建目标目录
New-Item -ItemType Directory -Force -Path $targetDir | Out-Null

# 复制文件
# ... 详细脚本见 scripts/package-release.ps1
```

## 📦 文件大小参考

典型的发布包大小：
- **主程序**：~2-5 MB
- **CefSharp 文件**：~100-150 MB（包含 Chromium）
- **前端文件**：~500 KB - 2 MB（取决于功能）
- **总计**：~100-160 MB

## ⚠️ 注意事项

### 1. .NET Framework 版本

确保目标机器已安装 **.NET Framework 4.7.2 或更高版本**。

### 2. Visual C++ 运行库

CefSharp 可能需要 Visual C++ 运行库。如果目标机器没有，需要：
- 在安装程序中包含运行库安装
- 或在文档中说明需要安装

### 3. 文件权限

确保应用有足够的权限：
- 读取 `wwwroot` 目录
- 写入用户数据目录（如果使用）

### 4. 杀毒软件

某些杀毒软件可能误报 CefSharp 的 DLL 文件。如果遇到，可以：
- 将应用添加到白名单
- 联系杀毒软件厂商

### 5. 调试符号文件（.pdb）

生产版本通常不需要 `.pdb` 文件，但保留它们有助于：
- 错误报告和调试
- 性能分析

可以根据需要决定是否包含。

## 🎯 版本号管理

建议使用语义化版本号：`主版本号.次版本号.修订号`

例如：`1.0.0`、`1.1.0`、`2.0.0`

更新版本号的位置：
- `frontend/package.json` - 前端版本
- `src/QJRWebWinform.WPF/Properties/AssemblyInfo.cs` - 程序集版本

## 📚 相关文档

- [README.md](../README.md) - 项目概述
- [Controller-Action架构使用说明.md](./Controller-Action架构使用说明.md) - 架构说明

## 🆘 常见问题

### Q: 构建失败，提示找不到文件？
A: 确保先构建前端，生成 `wwwroot` 目录。

### Q: 运行时提示找不到 CefSharp DLL？
A: 确保所有 CefSharp 相关文件都已复制到发布目录。

### Q: 前端页面显示空白？
A: 检查 `wwwroot` 目录是否正确复制，路径是否正确。

### Q: 如何减小发布包大小？
A: CefSharp 文件较大是正常的。可以考虑：
- 使用 CefSharp 的 AnyCPU 版本（自动选择架构）
- 移除不需要的 locale 文件（不推荐）

